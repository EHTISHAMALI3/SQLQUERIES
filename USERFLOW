CREATE TABLE Users (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    RollNo NVARCHAR(50) NOT NULL,
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    UserName NVARCHAR(256) NOT NULL UNIQUE,
    NormalizedUserName NVARCHAR(256) NOT NULL UNIQUE,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    NormalizedEmail NVARCHAR(256) NOT NULL UNIQUE,
    IsActive BIT NOT NULL DEFAULT 1,
    EmailConfirmed BIT NOT NULL DEFAULT 0,
    PasswordHash NVARCHAR(MAX) NULL,
    SecurityStamp NVARCHAR(MAX) NULL,
    ConcurrencyStamp NVARCHAR(MAX) NULL,
    ContactNo NVARCHAR(20) NULL,
    Address NVARCHAR(500) NULL,
    City NVARCHAR(100) NULL,
    Province NVARCHAR(100) NULL,
    English_Learning_level NVARCHAR(50) NULL,
    Zip NVARCHAR(20) NULL,
    PhoneNumber NVARCHAR(20) NULL,
    PhoneNumberConfirmed BIT NOT NULL DEFAULT 0,
    LockoutEnd DATETIME2 NULL,
    LockoutEnabled BIT NOT NULL DEFAULT 0,
    AccessFailedCount INT NOT NULL DEFAULT 0,
    Deleted BIT NOT NULL DEFAULT 0,
    CreatedBy UNIQUEIDENTIFIER NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedDate DATETIME2 NULL,
    DOB DATE NULL,
    Gender NVARCHAR(50) NULL,
    RefreshToken NVARCHAR(MAX) NULL,
    RefreshTokenExpiryTime DATETIME2 NULL,
    IsLockedOut BIT NOT NULL DEFAULT 0,
    LastLoginDate DATETIME2 NULL,
    UserTypeId UNIQUEIDENTIFIER NOT NULL,
    ClassId UNIQUEIDENTIFIER NULL,
    SchoolId UNIQUEIDENTIFIER NULL,
    SessionId UNIQUEIDENTIFIER NULL,
    ProfileImage NVARCHAR(MAX) NULL,

    CONSTRAINT FK_Users_Roles FOREIGN KEY (UserTypeId) REFERENCES Roles(UserTypeId),
    CONSTRAINT FK_Users_Class FOREIGN KEY (ClassId) REFERENCES Classes(Id),
    CONSTRAINT FK_Users_School FOREIGN KEY (SchoolId) REFERENCES Schools(Id),
    CONSTRAINT FK_Users_Session FOREIGN KEY (SessionId) REFERENCES Sessions(Id)
);





CREATE TABLE Sessions (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    SessionName NVARCHAR(255) NOT NULL UNIQUE,
    CreatedBy UNIQUEIDENTIFIER NULL,
    IsActive BIT NOT NULL DEFAULT 1,
    SessionStartDate DATE NOT NULL,
    SessionEndDate DATE NOT NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedAt DATETIME2 NULL,
    Deleted BIT NOT NULL DEFAULT 0
);



CREATE TABLE Schools (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    SchoolName NVARCHAR(255) NOT NULL UNIQUE,
    SchoolAddress NVARCHAR(500) NOT NULL,
    OwnerName NVARCHAR(255) NOT NULL,
    SchoolLogo NVARCHAR(MAX) NULL,
    CreatedBy UNIQUEIDENTIFIER NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedAt DATETIME2 NULL,
    Deleted BIT NOT NULL DEFAULT 0
);



CREATE TABLE Classes (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    ClassName NVARCHAR(255) NOT NULL UNIQUE,
    SchoolId UNIQUEIDENTIFIER NOT NULL,
    CreatedBy UNIQUEIDENTIFIER NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedAt DATETIME2 NULL,
    Deleted BIT NOT NULL DEFAULT 0,

    CONSTRAINT FK_Classes_School FOREIGN KEY (SchoolId) REFERENCES Schools(Id)
);


CREATE TABLE UserTypes (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    UserType NVARCHAR(100) NOT NULL UNIQUE,
    CreatedBy UNIQUEIDENTIFIER NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedAt DATETIME2 NULL,
    Deleted BIT NOT NULL DEFAULT 0
);

INSERT INTO UserTypes (Id, UserType, CreatedAt)
VALUES 
    (NEWID(), 'Super Admin', GETUTCDATE()),
    (NEWID(), 'Admin', GETUTCDATE()),
    (NEWID(), 'User', GETUTCDATE());


CREATE TABLE UserRoles (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    UserId UNIQUEIDENTIFIER NOT NULL,
    UserTypeId UNIQUEIDENTIFIER NOT NULL,
    AssignedBy UNIQUEIDENTIFIER NULL,
    AssignedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),

    CONSTRAINT FK_UserRoles_Users FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    CONSTRAINT FK_UserRoles_UserTypes FOREIGN KEY (UserTypeId) REFERENCES UserTypes(Id) ON DELETE CASCADE
);


CREATE TABLE AccessManagement (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    UserTypeId UNIQUEIDENTIFIER NOT NULL,
    CanRead BIT NOT NULL DEFAULT 1,
    CanCreate BIT NOT NULL DEFAULT 0,
    CanUpdate BIT NOT NULL DEFAULT 0,
    CanDelete BIT NOT NULL DEFAULT 0,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),

    CONSTRAINT FK_AccessManagement_UserTypes FOREIGN KEY (UserTypeId) REFERENCES UserTypes(Id) ON DELETE CASCADE
);


INSERT INTO AccessManagement (UserTypeId, CanRead, CanCreate, CanUpdate, CanDelete, CreatedAt)
SELECT Id, 1, 1, 1, 1, GETUTCDATE() FROM UserTypes WHERE UserType = 'Super Admin';

INSERT INTO AccessManagement (UserTypeId, CanRead, CanCreate, CanUpdate, CanDelete, CreatedAt)
SELECT Id, 1, 1, 1, 0, GETUTCDATE() FROM UserTypes WHERE UserType = 'Admin';

INSERT INTO AccessManagement (UserTypeId, CanRead, CanCreate, CanUpdate, CanDelete, CreatedAt)
SELECT Id, 1, 0, 0, 0, GETUTCDATE() FROM UserTypes WHERE UserType = 'User';



CREATE TABLE Pages (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    PageName NVARCHAR(255) NOT NULL UNIQUE,
    Route NVARCHAR(500) NOT NULL UNIQUE,
    CreatedBy UNIQUEIDENTIFIER NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedAt DATETIME2 NULL,
    Deleted BIT NOT NULL DEFAULT 0
);


CREATE TABLE PageContents (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    PageId UNIQUEIDENTIFIER NOT NULL,
    ContentType NVARCHAR(50) NOT NULL, -- e.g., 'text', 'image', 'html'
    Content NVARCHAR(MAX) NULL, -- Can store text, HTML, or image paths
    CreatedBy UNIQUEIDENTIFIER NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ModifiedBy UNIQUEIDENTIFIER NULL,
    ModifiedAt DATETIME2 NULL,
    Deleted BIT NOT NULL DEFAULT 0,

    CONSTRAINT FK_PageContents_Pages FOREIGN KEY (PageId) REFERENCES Pages(Id) ON DELETE CASCADE
);
